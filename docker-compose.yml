# 33GOD Full Stack Docker Compose
# Location: ~/code/33GOD/docker-compose.yml
#
# This compose file runs the complete 33GOD infrastructure stack:
# - Redis: Correlation tracking and caching
# - Bloodbank: FastAPI event bus API
# - Holocene: Mission Control dashboard (Vite → nginx production build)
# - Infra Dispatcher: Plane webhook dispatcher
#
# RabbitMQ: Uses existing theboard-rabbitmq from trunk-main via external network.
# Traefik: Uses existing proxy network for routing.

services:
  # ============================================================================
  # Redis - Correlation Tracking & Caching
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: 33god-redis
    hostname: 33god-redis
    ports:
      - "6381:6379"     # Redis port (6381 on host; 6380 used by theboard-redis)
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - 33god-network
    labels:
      - "traefik.enable=false"

  # ============================================================================
  # PostgreSQL - 33GOD Platform Database
  # ============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: 33god-postgres
    hostname: 33god-postgres
    ports:
      - "5434:5432"     # Postgres port (5434 on host; 5433 used by theboard)
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-delorenj}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-33god}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-delorenj} -d ${POSTGRES_DB:-33god}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - 33god-network
    labels:
      - "traefik.enable=false"
      - "33god.service=postgres"
      - "33god.description=Platform database for asset registry and shared tables"

  # ============================================================================
  # Postgres NOTIFY Bridge - Forwards DB events to Bloodbank
  # ============================================================================
  postgres-notify-bridge:
    build:
      context: ./services/postgres-notify-bridge
      dockerfile: Dockerfile
    container_name: 33god-postgres-notify-bridge
    hostname: postgres-notify-bridge
    environment:
      POSTGRES_DSN: postgresql://${POSTGRES_USER:-delorenj}:${POSTGRES_PASSWORD}@33god-postgres:5432/33god
      BLOODBANK_API_URL: http://bloodbank:8682
      NOTIFY_CHANNEL: bloodbank_events
    depends_on:
      postgres:
        condition: service_healthy
      bloodbank:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - 33god-network
    labels:
      - "traefik.enable=false"
      - "33god.service=postgres-notify-bridge"
      - "33god.description=Forwards Postgres NOTIFY events to Bloodbank"

  # ============================================================================
  # Bloodbank - Event Bus API
  # ============================================================================
  bloodbank:
    build:
      context: ./bloodbank
      dockerfile: Dockerfile
    container_name: 33god-bloodbank
    hostname: bloodbank
    ports:
      - "8682:8682"     # FastAPI port
    environment:
      # RabbitMQ Connection
      RABBIT_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@theboard-rabbitmq:5672/
      EXCHANGE_NAME: ${BLOODBANK_EXCHANGE:-bloodbank.events.v1}
      
      # Redis Connection
      REDIS_HOST: 33god-redis
      REDIS_PORT: "6379"
      
      # Schema Validation
      HOLYFIELDS_SCHEMA_DIR: /schemas
      SCHEMA_VALIDATION_ENABLED: "true"
      SCHEMA_VALIDATION_STRICT: "true"
      
      # Service Configuration
      BLOODBANK_PORT: "8682"
      BLOODBANK_HOST: "0.0.0.0"
      
      # Observability
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_ENDPOINT:-}
      PROMETHEUS_PORT: "9090"
    volumes:
      - ./holyfields/schemas:/schemas:ro
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8682/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - 33god-network
      - proxy
      - theboard-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bloodbank.rule=Host(`bloodbank.delo.sh`)"
      - "traefik.http.routers.bloodbank.entrypoints=websecure"
      - "traefik.http.routers.bloodbank.tls.certresolver=letsencrypt"
      - "traefik.http.services.bloodbank.loadbalancer.server.port=8682"

  # ============================================================================
  # Bloodbank WebSocket Relay - Real-time Event Streaming
  # ============================================================================
  bloodbank-ws-relay:
    build:
      context: ./bloodbank/websocket-relay
      dockerfile: Dockerfile
    container_name: 33god-bloodbank-ws-relay
    hostname: bloodbank-ws-relay
    ports:
      - "8683:8683"     # WebSocket port
    environment:
      # RabbitMQ Connection
      RABBIT_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@theboard-rabbitmq:5672/
      EXCHANGE_NAME: ${BLOODBANK_EXCHANGE:-bloodbank.events.v1}
      ROUTING_KEY: ${RELAY_ROUTING_KEY:-#}
      
      # WebSocket Server
      WS_HOST: "0.0.0.0"
      WS_PORT: "8683"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s=socket.socket(); s.connect((\"localhost\", 8683)); s.close()' || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - 33god-network
      - theboard-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bloodbank-ws.rule=Host(`bloodbank-ws.delo.sh`)"
      - "traefik.http.routers.bloodbank-ws.entrypoints=websecure"
      - "traefik.http.routers.bloodbank-ws.tls.certresolver=letsencrypt"
      - "traefik.http.services.bloodbank-ws.loadbalancer.server.port=8683"
      - "33god.service=bloodbank-ws-relay"
      - "33god.description=WebSocket relay for real-time Bloodbank events"

  # ============================================================================
  # Candystore - Event Store Manager ("The Historian")
  # Consumes ALL Bloodbank events, persists to PostgreSQL, serves REST API
  # ============================================================================
  candystore:
    build:
      context: ./services/candystore
      dockerfile: Dockerfile
    container_name: 33god-candystore
    hostname: candystore
    ports:
      - "8684:8080"     # Event store API port
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-delorenj}:${POSTGRES_PASSWORD}@33god-postgres:5432/${POSTGRES_DB:-33god}
      DATABASE_POOL_SIZE: "10"
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@theboard-rabbitmq:5672/
      BLOODBANK_EXCHANGE: ${BLOODBANK_EXCHANGE:-bloodbank.events.v1}
      EVENT_STORE_MANAGER_QUEUE: candystore_events
      EVENT_STORE_MANAGER_DLQ: candystore_events_dlq
      EVENT_STORE_MANAGER_HOST: "0.0.0.0"
      EVENT_STORE_MANAGER_PORT: "8080"
      API_PREFIX: /api/v1
      API_CORS_ORIGINS: '["http://localhost:3000","http://localhost:3360","https://holocene.delo.sh"]'
      LOG_LEVEL: INFO
      LOG_FORMAT: json
      ENVIRONMENT: production
    depends_on:
      postgres:
        condition: service_healthy
      bloodbank:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8080/health')\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - 33god-network
      - theboard-network
    labels:
      - "traefik.enable=false"
      - "33god.service=candystore"
      - "33god.description=Event persistence store - consumes and indexes all Bloodbank events"

  # ============================================================================
  # Holocene - Mission Control Dashboard
  # ============================================================================
  holocene:
    build:
      context: ./holocene
      dockerfile: Dockerfile
      args:
        - VITE_BLOODBANK_API_URL=/api/bloodbank
        - VITE_BLOODBANK_WS_URL=/ws
        - VITE_BLOODBANK_WS_FALLBACK_URL=/ws
    container_name: 33god-holocene
    hostname: holocene
    ports:
      - "11819:80"      # nginx serving built Vite app
    environment:
      # Runtime configuration (nginx serves static files, but API proxy needs this)
      BLOODBANK_API_URL: http://bloodbank:8682
      BLOODBANK_WS_URL: ws://bloodbank-ws-relay:8683
      
      # Plane API proxy configuration
      PLANE_33GOD_API_KEY: ${PLANE_33GOD_API_KEY:-}
      PROXY_PORT: "11820"
    volumes:
      # Mount avatars for static serving
      - ${OPENCLAW_AVATARS_PATH:-~/.openclaw/Avatars}:/usr/share/nginx/html/avatars:ro
    depends_on:
      bloodbank:
        condition: service_healthy
      candystore:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - 33god-network
      - proxy
    labels:
      - "traefik.enable=true"
      # Main router (HTML/JS/CSS) — behind Google Auth
      - "traefik.http.routers.holocene.rule=Host(`holocene.delo.sh`)"
      - "traefik.http.routers.holocene.entrypoints=websecure"
      - "traefik.http.routers.holocene.tls.certresolver=letsencrypt"
      - "traefik.http.routers.holocene.middlewares=google-auth@file"
      # WebSocket router — NO auth (WS can't do OAuth redirects)
      - "traefik.http.routers.holocene-ws.rule=Host(`holocene.delo.sh`) && PathPrefix(`/ws`)"
      - "traefik.http.routers.holocene-ws.entrypoints=websecure"
      - "traefik.http.routers.holocene-ws.tls.certresolver=letsencrypt"
      - "traefik.http.routers.holocene-ws.priority=200"
      # Shared service
      - "traefik.http.services.holocene.loadbalancer.server.port=80"

  # ============================================================================
  # Infra Dispatcher - Bloodbank Consumer for Plane Webhook Dispatch
  # ============================================================================
  infra-dispatcher:
    build:
      context: ./bloodbank
      dockerfile: Dockerfile
    container_name: 33god-infra-dispatcher
    hostname: infra-dispatcher
    # Override default command to run dispatcher instead of API
    command: ["python", "-m", "event_producers.infra_dispatcher"]
    environment:
      # RabbitMQ Connection (same as bloodbank)
      RABBIT_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@theboard-rabbitmq:5672/
      EXCHANGE_NAME: ${BLOODBANK_EXCHANGE:-bloodbank.events.v1}
      
      # OpenClaw Hook Configuration
      OPENCLAW_HOOK_TOKEN: ${OPENCLAW_HOOK_TOKEN:-}
      OPENCLAW_HOOK_URL: ${OPENCLAW_HOOK_URL:-http://host.docker.internal:18789/hooks/agent}
      OPENCLAW_HOOK_DELIVER: ${OPENCLAW_HOOK_DELIVER:-false}
      
      # Dispatch Rules (Ready Gate)
      INFRA_READY_STATES: ${INFRA_READY_STATES:-unstarted}
      INFRA_READY_LABELS: ${INFRA_READY_LABELS:-ready,automation:go}
      INFRA_COMPONENT_LABEL_PREFIX: ${INFRA_COMPONENT_LABEL_PREFIX:-comp:}
      
      # State Persistence
      INFRA_DISPATCH_STATE_PATH: /state/infra-dispatch-state.json
      
      # Health Check Configuration
      INFRA_RUN_CHECKS: ${INFRA_RUN_CHECKS:-true}
      INFRA_CHECK_TIMEOUT_SECONDS: ${INFRA_CHECK_TIMEOUT_SECONDS:-900}
      INFRA_COMPONENT_CHECKS_JSON: ${INFRA_COMPONENT_CHECKS_JSON:-}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      # State persistence (deduplication)
      - ${INFRA_DISPATCH_STATE_HOST_PATH:-~/.config/openclaw/infra-dispatch-state.json}:/state/infra-dispatch-state.json
      
      # Component source mounts for health checks
      - ./bloodbank:/components/bloodbank:ro
      - ./candystore:/components/candystore:ro
      - ./candybar:/components/candybar:ro
      - ./holyfields:/components/holyfields:ro
      - ${PJANGLER_HOST_PATH:-~/code/pjangler}:/components/pjangler:ro
    healthcheck:
      test: ["CMD-SHELL", "pidof python > /dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - 33god-network
      - theboard-network
    labels:
      - "traefik.enable=false"
      - "33god.service=infra-dispatcher"
      - "33god.description=Plane webhook dispatcher to OpenClaw"

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  redis-data:
    driver: local
  postgres-data:
    driver: local

# ==============================================================================
# Networks
# ==============================================================================
networks:
  33god-network:
    name: 33god-network
    driver: bridge
  proxy:
    external: true
  theboard-network:
    name: trunk-main_theboard-network
    external: true
